<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息传递 | Chrome 扩展(插件) 开发教程</title>
    <meta name="generator" content="VuePress 1.5.2">
    <script data-ad-client="ca-pub-6048304318304307" async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="Chrome 扩展(插件) 开发教程 2020 最新 Chrome 扩展官方文档教程中文版，从零开始开发一个浏览器插件教程。">
    <link rel="preload" href="/assets/css/0.styles.34d67128.css" as="style"><link rel="preload" href="/assets/js/app.fc4833c2.js" as="script"><link rel="preload" href="/assets/js/2.f6d2113b.js" as="script"><link rel="preload" href="/assets/js/25.30ff319b.js" as="script"><link rel="prefetch" href="/assets/js/10.54c1b5e8.js"><link rel="prefetch" href="/assets/js/11.1177d63f.js"><link rel="prefetch" href="/assets/js/12.4f08ede7.js"><link rel="prefetch" href="/assets/js/13.52c2aa08.js"><link rel="prefetch" href="/assets/js/14.e91af69a.js"><link rel="prefetch" href="/assets/js/15.944d6c2c.js"><link rel="prefetch" href="/assets/js/16.d5348d16.js"><link rel="prefetch" href="/assets/js/17.723ac56a.js"><link rel="prefetch" href="/assets/js/18.59caf6aa.js"><link rel="prefetch" href="/assets/js/19.45a51779.js"><link rel="prefetch" href="/assets/js/20.2b5a6534.js"><link rel="prefetch" href="/assets/js/21.3ddf5e36.js"><link rel="prefetch" href="/assets/js/22.9fca2040.js"><link rel="prefetch" href="/assets/js/23.6044a98c.js"><link rel="prefetch" href="/assets/js/24.92235b3c.js"><link rel="prefetch" href="/assets/js/26.b9e21f4d.js"><link rel="prefetch" href="/assets/js/27.ec83ca39.js"><link rel="prefetch" href="/assets/js/28.0464ccd8.js"><link rel="prefetch" href="/assets/js/29.61bc6310.js"><link rel="prefetch" href="/assets/js/3.ca73f900.js"><link rel="prefetch" href="/assets/js/4.1ab84611.js"><link rel="prefetch" href="/assets/js/5.adc2ad76.js"><link rel="prefetch" href="/assets/js/6.2fb516db.js"><link rel="prefetch" href="/assets/js/7.9e7b621a.js"><link rel="prefetch" href="/assets/js/8.80c3d469.js"><link rel="prefetch" href="/assets/js/9.497af2c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34d67128.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Chrome 扩展(插件) 开发教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/what-is-extensions.html" class="nav-link">
  官方中文版教程
</a></div><div class="nav-item"><a href="/blog/pornhub-video-download-extension.html" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/facert/chrome-extension-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/what-is-extensions.html" class="nav-link">
  官方中文版教程
</a></div><div class="nav-item"><a href="/blog/pornhub-video-download-extension.html" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/facert/chrome-extension-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/blog/pornhub-video-download-extension.html" class="sidebar-heading clickable"><span>Blog</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/" class="sidebar-heading clickable router-link-active open"><span>官方教程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/what-is-extensions.html" class="sidebar-link">什么是扩展</a></li><li><a href="/guide/getstarted.html" class="sidebar-link">入门教程</a></li><li><a href="/guide/overview.html" class="sidebar-link">总览</a></li><li><a href="/guide/manifest.html" class="sidebar-link">Manifest 文件格式</a></li><li><a href="/guide/background_content.html" class="sidebar-link">使用后台脚本管理事件</a></li><li><a href="/guide/user_interface.html" class="sidebar-link">设计交互界面</a></li><li><a href="/guide/content_scripts.html" class="sidebar-link">内容脚本 Content Scripts</a></li><li><a href="/guide/permission_warnings.html" class="sidebar-link">声明权限并警告用户</a></li><li><a href="/guide/options.html" class="sidebar-link">给用户选项</a></li><li><a href="/guide/devguide.html" class="sidebar-link">开发扩展</a></li><li><a href="/guide/performance.html" class="sidebar-link">达到最佳性能</a></li><li><a href="/guide/user_privacy.html" class="sidebar-link">保护用户隐私</a></li><li><a href="/guide/tut_debugging.html" class="sidebar-link">调试扩展</a></li><li><a href="/guide/tut_oauth.html" class="sidebar-link">OAuth2</a></li><li><a href="/guide/a11y.html" class="sidebar-link">辅助功能（a11y）</a></li><li><a href="/guide/contentSecurityPolicy.html" class="sidebar-link">内容安全政策（CSP）</a></li><li><a href="/guide/xhr.html" class="sidebar-link">跨域XMLHttpRequest</a></li><li><a href="/guide/messaging.html" aria-current="page" class="active sidebar-link">消息传递</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/messaging.html#消息传递" class="sidebar-link">消息传递</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/messaging.html#简单的一次性请求" class="sidebar-link">简单的一次性请求</a></li><li class="sidebar-sub-header"><a href="/guide/messaging.html#长连接" class="sidebar-link">长连接</a></li><li class="sidebar-sub-header"><a href="/guide/messaging.html#交叉扩展消息传递" class="sidebar-link">交叉扩展消息传递</a></li><li class="sidebar-sub-header"><a href="/guide/messaging.html#从网页发送消息" class="sidebar-link">从网页发送消息</a></li><li class="sidebar-sub-header"><a href="/guide/messaging.html#本机消息传递" class="sidebar-link">本机消息传递</a></li><li class="sidebar-sub-header"><a href="/guide/messaging.html#安全注意事项" class="sidebar-link">安全注意事项</a></li><li class="sidebar-sub-header"><a href="/guide/messaging.html#例子" class="sidebar-link">例子</a></li></ul></li></ul></li><li><a href="/guide/nativeMessaging.html" class="sidebar-link">本机消息</a></li><li><a href="/guide/match_patterns.html" class="sidebar-link">匹配模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="消息传递"><a href="#消息传递" class="header-anchor">#</a> 消息传递</h2> <p>由于内容脚本在网页而不是扩展程序的上下文中运行，因此它们通常需要某种与扩展程序其余部分进行通信的方式。例如，RSS 阅读器扩展程序可以使用内容脚本来检测页面上 RSS 摘要的存在，然后通知后台页面以显示该页面的操作图标。</p> <p>扩展及其内容脚本之间的通信使用消息传递来实现。任何一方都可以监听从另一端发送的消息，并在同一通道上进行响应。消息可以包含任何有效的 JSON 对象（空，布尔值，数字，字符串，数组或对象）。有一个简单的 API 可以处理一次性请求，而一个更复杂的 API 则可以使您拥有长连接，以便与共享上下文交换多条消息。如果您知道扩展名，也可以将消息发送到另一个扩展，该 ID 在<a href="https://developer.chrome.com/extensions/messaging#external" target="_blank" rel="noopener noreferrer">交叉扩展消息<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>部分中进行了介绍。</p> <h3 id="简单的一次性请求"><a href="#简单的一次性请求" class="header-anchor">#</a> 简单的一次性请求</h3> <p>如果只需要向扩展的另一部分发送一条消息（并有选择地返回响应），则应使用简化的runtime.sendMessage 或tabs.sendMessage。这样，您就可以从内容脚本向扩展发送一次 JSON 序列化的消息，反之亦然。可选的回调参数允许您从另一端处理响应（如果有）。</p> <p>从内容脚本发送请求如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>farewell<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从扩展向内容脚本发送请求看起来非常相似，不同之处在于，您需要指定将请求发送至哪个选项卡。 本示例演示了将消息发送到所选选项卡中的内容脚本。</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>active<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> currentWindow<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tabs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>farewell<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在接收端，您需要设置 runtime.onMessage 事件监听器以处理消息。 在内容脚本或扩展页面中，外观看起来相同。</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span>tab <span class="token operator">?</span>
                <span class="token string">&quot;from a content script:&quot;</span> <span class="token operator">+</span> sender<span class="token punctuation">.</span>tab<span class="token punctuation">.</span>url <span class="token operator">:</span>
                <span class="token string">&quot;from the extension&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>greeting <span class="token operator">==</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>farewell<span class="token operator">:</span> <span class="token string">&quot;goodbye&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在上面的示例中，sendResponse 被同步调用。 如果要异步使用 sendResponse，请添加 return true; 到 onMessage 事件处理器。</p> <blockquote><p>注意：如果多个页面都正在监听 onMessage 事件，则只有第一个调用 sendResponse() 的用户才能成功发送响应。对该事件的所有其他响应将被忽略。</p></blockquote> <blockquote><p>注意：sendResponse 回调仅在同步使用或事件处理程序返回 true 表示异步响应时才有效。如果没有处理程序返回 true 或 sendResponse 回调被垃圾回收后，则 sendMessage 回调函数将被自动调用。</p></blockquote> <h3 id="长连接"><a href="#长连接" class="header-anchor">#</a> 长连接</h3> <p>有时对话的持续时间长于单个请求和响应，这很有用。在这种情况下，可以分别使用runtime.connect 或 tabs.connect 来打开从内容脚本到扩展页面的长生命周期通道，反之亦然。通道可以有一个名称，以便区分不同类型的连接。</p> <p>一个用例可能是自动填写表格扩展。内容脚本可以为特定的登录打开扩展页面的通道，并为页面上的每个输入元素向扩展发送消息，以请求填写表单数据。共享连接允许扩展保持共享状态接收来自内容脚本的几条消息。</p> <p>建立连接时，会为两端提供一个 runtime.Port 对象，该对象用于通过该连接发送和接收消息。</p> <p>这是从内容脚本打开通道并发送和收听消息的方式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">&quot;knockknock&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>joke<span class="token operator">:</span> <span class="token string">&quot;Knock knock&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>question <span class="token operator">==</span> <span class="token string">&quot;Who's there?&quot;</span><span class="token punctuation">)</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>answer<span class="token operator">:</span> <span class="token string">&quot;Madame&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>question <span class="token operator">==</span> <span class="token string">&quot;Madame who?&quot;</span><span class="token punctuation">)</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>answer<span class="token operator">:</span> <span class="token string">&quot;Madame... Bovary&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从扩展向内容脚本发送请求看起来非常相似，不同之处在于，需要指定要连接到的选项卡。只需将以上示例中的 connect 连接替换为 tabs.connect。</p> <p>为了处理接收的连接，您需要设置runtime.onConnect 事件监听器。从内容脚本或扩展页面看，它看起来是相同的。当扩展的另一部分调用 “connect()” 时，将触发此事件，以及可用于通过连接发送和接收消息的 runtime.Port 对象。 这是响应接收连接的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>port<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;knockknock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>joke <span class="token operator">==</span> <span class="token string">&quot;Knock knock&quot;</span><span class="token punctuation">)</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>question<span class="token operator">:</span> <span class="token string">&quot;Who's there?&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>answer <span class="token operator">==</span> <span class="token string">&quot;Madame&quot;</span><span class="token punctuation">)</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>question<span class="token operator">:</span> <span class="token string">&quot;Madame who?&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>answer <span class="token operator">==</span> <span class="token string">&quot;Madame... Bovary&quot;</span><span class="token punctuation">)</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>question<span class="token operator">:</span> <span class="token string">&quot;I don't get it.&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="端口生命周期"><a href="#端口生命周期" class="header-anchor">#</a> 端口生命周期</h4> <p>端口被设计为扩展的不同部分之间的双向通信方法，其中（顶层）帧被视为最小部分。</p> <p>调用 tabs.connect，runtime.connect 或runtime.connectNative 时，将创建一个端口。该端口可立即用于通过 postMessage 将消息发送到另一端。</p> <p>如果选项卡中有多个 frame，则调用 tabs.connect会导致对 runtime.onConnect 事件的多次调用（选项卡中的每个 frame 一次）。同样，如果使用runtime.connect，则 onConnect 事件可能会被触发多次（扩展过程中的每个 frame 一次）。</p> <p>您可能想知道连接何时关闭，例如，是否为每个打开的端口维护单独的状态。为此，可以侦听runtime.Port.onDisconnect 事件。当通道另一侧没有有效端口时，将触发此事件。以下会发生这种情况：</p> <ul><li>另一端没有用于 runtime.onConnect 的监听器。</li> <li>包含端口的选项卡已卸载（例如，如果浏览了该选项卡）。</li> <li>调用连接所在的 frame 已卸载。</li> <li>接收端口（通过 runtime.onConnect）的所有frame 均已卸载。</li> <li>另一端调用 runtime.Port.disconnect。请注意，如果连接调用在接收方的端部产生多个端口，并且在这些端口中的任何一个上调用了connect() ，则 onDisconnect 事件仅在发送方的端口上触发，而不在其他端口上触发。</li></ul> <h3 id="交叉扩展消息传递"><a href="#交叉扩展消息传递" class="header-anchor">#</a> 交叉扩展消息传递</h3> <p>除了在扩展中的不同组件之间发送消息之外，您还可以使用消息传递 API 与其他扩展进行通信。 这使您可以提供公共 api 供其他扩展利用。</p> <p>监听传入的请求和连接与内部通信类似，不同之处在于，您使用 runtime.onMessageExternal 或runtime.onConnectExternal 方法。 这是示例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">/</span> For simple requests<span class="token operator">:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessageExternal<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sender<span class="token punctuation">.</span>id <span class="token operator">==</span> blocklistedExtension<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// don't allow this extension access</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>getTargetData<span class="token punctuation">)</span>
      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>targetData<span class="token operator">:</span> targetData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>activateLasers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token function">activateLasers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>activateLasers<span class="token operator">:</span> success<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// For long-lived connections:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnectExternal<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// See other examples for sample onMessage handlers.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>同样，向另一扩展名发送消息类似于在扩展中发送消息。唯一的区别是必须传递要与之通信的扩展的ID。 例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// The ID of the extension we want to talk to.</span>
<span class="token keyword">var</span> laserExtensionId <span class="token operator">=</span> <span class="token string">&quot;abcdefghijklmnoabcdefhijklmnoabc&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Make a simple request:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>laserExtensionId<span class="token punctuation">,</span> <span class="token punctuation">{</span>getTargetData<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">targetInRange</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>targetData<span class="token punctuation">)</span><span class="token punctuation">)</span>
      chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>laserExtensionId<span class="token punctuation">,</span> <span class="token punctuation">{</span>activateLasers<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start a long-running conversation:</span>
<span class="token keyword">var</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>laserExtensionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="从网页发送消息"><a href="#从网页发送消息" class="header-anchor">#</a> 从网页发送消息</h3> <p>与<a href="https://developer.chrome.com/extensions/messaging#external" target="_blank" rel="noopener noreferrer">跨扩展消息传递<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>类似，您的应用或扩展程序可以接收和响应来自常规网页的消息。 要使用此功能，必须在 manifest.json 中指定要与之通信的网站。例如：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;externally_connectable&quot;: {
  &quot;matches&quot;: [&quot;*://*.example.com/*&quot;]
}
</code></pre></div><p>这会将消息传递 API 公开到与您指定的 URL模式匹配的任何页面。 RL模式必须至少包含二级域-即，禁止使用主机名模式，例如 “<em>”，“</em>.com”，“<em>.co.uk” 和 “</em>.appspot.com” 。在网页上，使用 runtime.sendMessage 或runtime.connect API 将消息发送到特定的应用程序或扩展。例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// The ID of the extension we want to talk to.</span>
<span class="token keyword">var</span> editorExtensionId <span class="token operator">=</span> <span class="token string">&quot;abcdefghijklmnoabcdefhijklmnoabc&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Make a simple request:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>editorExtensionId<span class="token punctuation">,</span> <span class="token punctuation">{</span>openUrlInEditor<span class="token operator">:</span> url<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>success<span class="token punctuation">)</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在应用程序或扩展中，您可以通过runtime.onMessageExternal或runtime.onConnectExternal API 监听来自网页的消息，类似于交叉扩展消息传递。只有网页可以初始化连接。 这是一个例子：</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessageExternal<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sender<span class="token punctuation">.</span>url <span class="token operator">==</span> blocklistedWebsite<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// don't allow this web page access</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>openUrlInEditor<span class="token punctuation">)</span>
      <span class="token function">openUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>openUrlInEditor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="本机消息传递"><a href="#本机消息传递" class="header-anchor">#</a> 本机消息传递</h3> <p>扩展程序和应用程序可以与注册为本地消息传递主机的本地应用程序交换消息。要了解有关此功能的更多信息，请参阅<a href="https://developer.chrome.com/extensions/nativeMessaging" target="_blank" rel="noopener noreferrer">本机消息传递<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="安全注意事项"><a href="#安全注意事项" class="header-anchor">#</a> 安全注意事项</h3> <h4 id="内容脚本的可信度较低"><a href="#内容脚本的可信度较低" class="header-anchor">#</a> 内容脚本的可信度较低</h4> <p>内容脚本的可信度不及扩展程序后台页面（例如，恶意网页可能会感染运行内容脚本的渲染器进程）。假设来自内容脚本的消息可能是攻击者制作的，并确保验证和清除所有输入。假设发送到内容脚本的任何数据都可能泄漏到网页。限制可以由从内容脚本接收的消息触发的权限操作的范围。</p> <h4 id="跨站脚本"><a href="#跨站脚本" class="header-anchor">#</a> 跨站脚本</h4> <p>当从内容脚本或其他扩展接收到消息时，您的脚本应注意不要成为跨站脚本的受害者。此建议适用于在扩展程序后台页面中运行的脚本以及在其他 Web 来源中运行的内容脚本。具体来说，请避免使用以下危险的API：</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// WARNING! Might be evaluating an evil script!</span>
  <span class="token keyword">var</span> resp <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>farewell <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// WARNING! Might be injecting a malicious script!</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;resp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> response<span class="token punctuation">.</span>farewell<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>相反，请选择不运行脚本的更安全的API：</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// JSON.parse does not evaluate the attacker's scripts.</span>
  <span class="token keyword">var</span> resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>farewell<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// innerText does not let the attacker inject HTML elements.</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;resp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> response<span class="token punctuation">.</span>farewell<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h3> <p>您可以在 <a href="https://chromium.googlesource.com/chromium/src/+/master/chrome/common/extensions/docs/examples/api/messaging/" target="_blank" rel="noopener noreferrer">examples/api/messaging<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 目录中找到通过消息进行通信的简单示例。 <a href="https://developer.chrome.com/extensions/nativeMessaging#examples" target="_blank" rel="noopener noreferrer">本机消息传递示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 演示了 Chrome应用如何与本机应用通信。 有关更多示例和查看源代码的帮助，请参阅<a href="https://developer.chrome.com/extensions/samples" target="_blank" rel="noopener noreferrer">示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/xhr.html" class="prev">
        跨域XMLHttpRequest
      </a></span> <span class="next"><a href="/guide/nativeMessaging.html">
        本机消息
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fc4833c2.js" defer></script><script src="/assets/js/2.f6d2113b.js" defer></script><script src="/assets/js/25.30ff319b.js" defer></script>
  </body>
</html>
